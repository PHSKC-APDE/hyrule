<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ML Record Linkage</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="_targets_files/libs/clipboard/clipboard.min.js"></script>
<script src="_targets_files/libs/quarto-html/quarto.js"></script>
<script src="_targets_files/libs/quarto-html/popper.min.js"></script>
<script src="_targets_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="_targets_files/libs/quarto-html/anchor.min.js"></script>
<link href="_targets_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="_targets_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="_targets_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="_targets_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="_targets_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="_targets_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="_targets_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="_targets_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ML Record Linkage</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<section id="about-this-document" class="level2">
<h2 class="anchored" data-anchor-id="about-this-document">About this document</h2>
<p>This document is an example implementation of machine learning record linkage within a <a href="https://books.ropensci.org/targets/">targets workflow</a>. While it is designed to be a runnable pipeline, the primary goal of this example is to provide ideas and show options that analysts can adapt to their own projects.</p>
<p>The funding and inspiration for this document derives from the NO HARMS grant conducted at Public Health - Seattle &amp; King County and funded by the CDC. The pipeline and methods described below are heavily influenced by the NO HARMS pipeline, but are intended to be more generalized and flexible.</p>
<section id="useful-concepts" class="level3">
<h3 class="anchored" data-anchor-id="useful-concepts">Useful Concepts</h3>
<p>Users should familiarize themselves with the following R-packages and/or methodological concepts:</p>
<ol type="1">
<li><a href="https://books.ropensci.org/targets/">targets</a> and <a href="https://docs.ropensci.org/tarchetypes/"><code>tarchetypes</code></a>: These R-packages are used to orchestrate the linkage pipeline. A targets pipeline is a directed acyclic graph that governs how inputs, intermediate steps, and outputs all interact/flow into each other. The pipeline can identify changes in the code and inputs for a particular step and propagate the need to update to downstream steps. Via some partner packages (e.g.&nbsp;<a href="https://github.com/wlandau/crew"><code>crew</code></a>), a targets pipeline can be computed in parallel fairly easily as the full dependency chain is pre-specified.</li>
<li><a href="https://github.com/Rdatatable/data.table"><code>data.table</code></a>, <a href="https://github.com/duckdb/duckdb-r">duckdb</a> (R-package, overall reference): Most of the data manipulation within this pipeline is either conducted via the <code>data.table</code> R-package or <code>duckdb</code> dialect sql (via the <code>DBI</code>) package. The <a href="https://glue.tidyverse.org/"><code>glue</code></a> package is often used to craft sql statements.</li>
<li><code>.parquet</code> files: The <a href="https://arrow.apache.org/docs/r/"><code>arrow</code></a> package (along with <code>duckdb</code>) provides read/write routines for <code>.parquet</code> files. <code>.parquet</code> files are used because they are reasonably efficient storage wise and allow for partial read/writes. <code>DuckDB</code> in particular has effective routines for reading/manipulating <code>.parquet</code> files.</li>
<li><a href="https://www.tidymodels.org/"><code>tidymodels</code></a>: This example (and the <code>hyrule</code> package) relies on the <code>tidymodels</code> suite of packages for model specification, fitting, and evaluation. The main packages used are <a href="https://parsnip.tidymodels.org/"><code>parnsip</code></a>, <a href="https://workflows.tidymodels.org/"><code>workflows</code></a>, <a href="https://tune.tidymodels.org/"><code>tune</code></a>, <a href="https://stacks.tidymodels.org/"><code>stacks</code></a>, and <a href="https://yardstick.tidymodels.org/"><code>yardstick</code></a>.</li>
<li><em>machine learning</em>: This example uses <a href="https://xgboost.readthedocs.io/en/stable/R-package/xgboostPresentation.html"><code>xgboost</code></a> gradient boosted machines, <a href="https://github.com/imbs-hl/ranger"><code>ranger</code></a> random forests, and <a href="https://cran.r-project.org/web/packages/kernlab/kernlab.pdf"><code>kernlab</code></a> support vector machines.</li>
<li><a href="https://en.wikipedia.org/wiki/Ensemble_learning"><em>stacking/ensemble learning</em></a>: This method uses stacked generalization (aka stacking) for model ensembling. The <a href="https://stacks.tidymodels.org/"><code>stacks</code></a> package provides the implementation.</li>
<li><a href="https://en.wikipedia.org/wiki/Ensemble_learning"><code>igraph</code></a>: A package for working with networks/graphs. Collections of 1:1 matches may aggregate into full-fledged networks and can be analyzed as such.</li>
<li><a href="https://journal.r-project.org/archive/2014-1/loo.pdf"><em>string distance metrics</em></a>: Many of the character variable based comparisons (e.g.&nbsp;name similarity) are string distance metrics. More details can be found here. Implementation is done via <a href="https://duckdb.org/docs/sql/functions/char.html"><code>DuckDB</code></a> routines.</li>
</ol>
</section>
<section id="machines-vs.-probabilistic-methods" class="level3">
<h3 class="anchored" data-anchor-id="machines-vs.-probabilistic-methods">Machines vs.&nbsp;probabilistic methods</h3>
</section>
<section id="code-location" class="level3">
<h3 class="anchored" data-anchor-id="code-location">Code Location</h3>
</section>
<section id="glossary" class="level3">
<h3 class="anchored" data-anchor-id="glossary">Glossary</h3>
<ol type="1">
<li><p>Source system (<code>source_system</code>): A dataset</p></li>
<li><p>Source Id (<code>source_id</code>): The unique record identifier within a source system. Within a source system, all records with the same source id are considered a single entity.</p></li>
<li><p>hash id (<code>clean_hash</code>): A custom generated unique identifier that is nested within a source system and source id that specifies a specific set of identifiers. For example, Dan will result in a different hash id than Daniel, even with all the other inputs held the same. The hash id serves as the base unit of analysis for the matching (that is, the matches are between hash ids). Things are later aggregated to the source system - source id level</p></li>
</ol>
</section>
</section>
</section>
<section id="workflow-summary" class="level1">
<h1>Workflow Summary</h1>
</section>
<section id="set-up" class="level1">
<h1>Set up</h1>
<section id="pipeline-setup" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-setup">Pipeline setup</h2>
<p>These packages are required to set up the pipeline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'hyrule'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tarchetypes)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'sf'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Linking to GEOS 3.12.2, GDAL 3.9.3, PROJ 9.4.1; sf_use_s2() is TRUE</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'data.table'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remove the <code>_targets_r</code> directory previously written by non-interactive runs of the report.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_unscript</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getwd</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "C:/Users/DCASEY.KC/code/hyrule/example_workflow"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>targets<span class="sc">::</span><span class="fu">tar_config_get</span>(<span class="st">"script"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "_targets.R"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js"></pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="packages-and-functions" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-functions">Packages and functions</h2>
<p>These packages and functions are required to have the pipeline run.</p>
<div class="cell" data-tar_globals="true">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_option_set</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">packages =</span> <span class="fu">c</span>(<span class="st">'data.table'</span>, <span class="st">'hyrule'</span>, <span class="st">'stringr'</span>, <span class="st">'arrow'</span>, <span class="st">'duckdb'</span>, <span class="st">'DBI'</span>, <span class="st">'glue'</span>, <span class="st">'stringr'</span>, <span class="st">'sf'</span>, <span class="st">'tidymodels'</span>, <span class="st">'workflows'</span>, <span class="st">'stacks'</span>, <span class="st">'dplyr'</span>, <span class="st">'ranger'</span>, <span class="st">'xgboost'</span>, <span class="st">'rlang'</span>, <span class="st">'igraph'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Much of the code/functions to make the pipeline run are stored in example_workflow/R</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_source</span>()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify input and output directories</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>outdir <span class="ot">=</span> <span class="st">'output/'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># other global variables</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>apply_screen <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">=</span> <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">99</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/globals/define-globals.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-record-linkage-pipeline" class="level1">
<h1>ML Record Linkage Pipeline</h1>
<section id="prepare-data" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data">Prepare Data</h2>
<p>This section loads, cleans, organizes, and stores data inputs.</p>
<p>There are two main approaches to record linkage:</p>
<ol type="1">
<li>Link only: Data sets are assumed to have no duplicates, and therefore within dataset linkages are computed. This is specified during the blocking step, and in this example, largely depends on a <code>source_system</code> variable.</li>
<li>De-duplicate (and link): One or more datasets are appended together and within and between dataset linkages are computed.</li>
</ol>
<p>Determining on what type of approach to take occurs during the blocking step (which determines the pairs to be evaluated).</p>
<section id="an-aside-on-types-of-identifiers" class="level3">
<h3 class="anchored" data-anchor-id="an-aside-on-types-of-identifiers">An aside on types of identifiers</h3>
<p>For this workflow, identifiers and other variables come in a few main flavors:</p>
<ol type="1">
<li>Primary identifiers are things like source system, source id, name, date of birth, social security, and sex/gender. These variables generally do not vary over time – or at least, if they do, it happens only sporadically. These identifiers (or some similar subset) represent the core of a record and are often the basis for blocking criteria.</li>
<li>Secondary identifiers are things like address, ZIP code, and phone number. These are things that may change with regularity and where the temporal characteristics of their appearance may be informative.</li>
<li>Contextual variables are all other things that may be used for determining whether record A represents the same entity as record B. Some examples may include: household size, term frequency adjustment, possibility of being a twin, etc.</li>
</ol>
</section>
<section id="primary-identifiers" class="level3">
<h3 class="anchored" data-anchor-id="primary-identifiers">Primary Identifiers</h3>
<p>In the code below, the <code>tarchetypes::tar_files_input</code> ingests the file path of the supplied data files and makes a checkpoint on the file – beginning the dependency chain</p>
<p>The <a href="R/init_data.R"><code>init_data</code></a> function loads the data passed via the <code>input</code> argument and uses some hyrule functions to do common cleaning routines (in a somewhat opinionated manner). In this case, the two input datasets (<code>input_1</code> and <code>input_2</code>) are appended together and processed at the same time because the rest of the process assumes one “data” file/table with a <code>source_system</code> column that differentiates between the data specified by <code>input_1</code> versus <code>input_2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file paths to data</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  tarchetypes<span class="sc">::</span><span class="fu">tar_files_input</span>(input_1, <span class="st">'../data-raw/fake_one.parquet'</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  tarchetypes<span class="sc">::</span><span class="fu">tar_files_input</span>(input_2, <span class="st">'../data-raw/fake_two.parquet'</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load, clean, and save datasets</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(data, <span class="fu">init_data</span>(<span class="fu">c</span>(input_1, input_2), <span class="fu">file.path</span>(outdir, <span class="st">'data.parquet'</span>)), <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/primary-identifiers.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Within the <code>init_data</code> function, the following steps occur:</p>
<ol type="1">
<li>Via <a href="../R/utilities.R"><code>hyrule::clean_names</code></a>, name columns are stripped of non-character values and common prefixes/suffixes are removed. <a href="../R/utilities.R"><code>hyrule::remove_spaces</code></a> then removes any white space characters.</li>
<li>Date of birth is converted into a date format and restricted to be from 1901 to the current year.</li>
<li>Sex is converted into a standard character column ( e.g.&nbsp;‘Male’ and ‘Female’ is converted to ‘M’ and ‘F’). Anything not in those two categories is set to NA.</li>
<li>Some SSN cleaning code is available as comments. This code, if applied, converts SSNs to strings of only numerics, removes common junk SSNs, and converts things to a standardized 9 digit number (as a character column to allow for SSNs beginning with 0).</li>
<li>Rows with too much missing information are dropped from the dataset</li>
<li>Rows with partial data density are filled in using data from other rows within the same source id. For example, if rows 1, 2 and 3 all derive from the same source id, and rows 2 and 3 have the same middle initial value but row 1 is NA, that NA is overwritten by the value present in rows 2 and 3. In the event that 2 and 3 disagree, then row 1 remains blank for that variable.</li>
</ol>
<p>While these steps are good starting points for any linkage project, they should not be considered immutable or complete. Each project will likely require its own data cleaning routines as data can be messy in nearly infinite ways.</p>
<section id="row-hashes" class="level4">
<h4 class="anchored" data-anchor-id="row-hashes">Row hashes</h4>
<p>The final main step fo the <code>init_data</code> function is the creation of a row-wise hash is generated based off the cleaned primary identifiers – in this case, source system, source id, name, dob, and sex. This hash will subsequently be used as the main unique row identifier and it is used to nest variations of primary variables within a given source system and source id combination.</p>
<p>Practically, using the hash (instead of source id) as the low-level identifier instead of source id allows for more data available by source id to be leveraged to improve the linkage process. For example, if source ID sometimes has Richard as the first name and sometimes as Rick, then both permutations can be used for blocking and evaluating possible links to identify more matches.</p>
<p>Handling the data in this way (row based) instead of aggregating thing into list-columns and using set operations also improves computational efficiency – especially for blocking.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>before <span class="ot">=</span> <span class="fu">setDT</span>(arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="fu">tar_read</span>(input_1)))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(before))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 4%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">street_number</th>
<th style="text-align: left;">street_name</th>
<th style="text-align: left;">source_id</th>
<th style="text-align: left;">first_name</th>
<th style="text-align: left;">middle_initial</th>
<th style="text-align: left;">last_name</th>
<th style="text-align: left;">sex</th>
<th style="text-align: left;">date_of_birth</th>
<th style="text-align: left;">unit_number</th>
<th style="text-align: right;">X</th>
<th style="text-align: right;">Y</th>
<th style="text-align: left;">zip_code</th>
<th style="text-align: left;">source_system</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">0_9431</td>
<td style="text-align: left;">Denise</td>
<td style="text-align: left;">H</td>
<td style="text-align: left;">Rogers</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">09/28/1986</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
<tr class="even">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">0_5728</td>
<td style="text-align: left;">Shaneka</td>
<td style="text-align: left;">T</td>
<td style="text-align: left;">Pullins</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">10/15/1977</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">0_11287</td>
<td style="text-align: left;">Laila</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">Garrett</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">01/01/1990</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
<tr class="even">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">1st avenue south</td>
<td style="text-align: left;">0_8875</td>
<td style="text-align: left;">Tara</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">Lacroix</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">05/12/1991</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">1st avenue south</td>
<td style="text-align: left;">0_11866</td>
<td style="text-align: left;">Angela</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">Hampton</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">10/10/1993</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
<tr class="even">
<td style="text-align: left;">NA</td>
<td style="text-align: left;">25th st e</td>
<td style="text-align: left;">0_11139</td>
<td style="text-align: left;">Cassandra</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">Man Of The House</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">07/09/1957</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">System 1</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>after <span class="ot">=</span> <span class="fu">setDT</span>(arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="fu">tar_read</span>(data)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(after))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">source_system</th>
<th style="text-align: left;">source_id</th>
<th style="text-align: left;">first_name_noblank</th>
<th style="text-align: left;">middle_name_noblank</th>
<th style="text-align: left;">last_name_noblank</th>
<th style="text-align: left;">sex_clean</th>
<th style="text-align: left;">dob_clean</th>
<th style="text-align: left;">clean_hash</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">System 1</td>
<td style="text-align: left;">0_100</td>
<td style="text-align: left;">EVA</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">MCMILLON</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">1943-12-08</td>
<td style="text-align: left;">62fe05da67ded8f2bea61c5a2ae1d5b4</td>
</tr>
<tr class="even">
<td style="text-align: left;">System 1</td>
<td style="text-align: left;">0_10000</td>
<td style="text-align: left;">ERIC</td>
<td style="text-align: left;">J</td>
<td style="text-align: left;">PERES</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">1972-02-15</td>
<td style="text-align: left;">4de711d441888ae9aecc58c1f3d5b98c</td>
</tr>
<tr class="odd">
<td style="text-align: left;">System 2</td>
<td style="text-align: left;">0_10001</td>
<td style="text-align: left;">AMANDA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">PEREZ</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">1982-07-10</td>
<td style="text-align: left;">de38b20096bdec032fe5ac12e7fe3488</td>
</tr>
<tr class="even">
<td style="text-align: left;">System 2</td>
<td style="text-align: left;">0_10002</td>
<td style="text-align: left;">AKBERTO</td>
<td style="text-align: left;">K</td>
<td style="text-align: left;">PEREZ</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">2006-08-02</td>
<td style="text-align: left;">656663bf9b773bc1df222a54dde09993</td>
</tr>
<tr class="odd">
<td style="text-align: left;">System 2</td>
<td style="text-align: left;">0_10003</td>
<td style="text-align: left;">FELICIA</td>
<td style="text-align: left;">L</td>
<td style="text-align: left;">LADYOFTHEHOUSE</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">1971-03-08</td>
<td style="text-align: left;">faf768bdf6136246e2909f47ecd5d979</td>
</tr>
<tr class="even">
<td style="text-align: left;">System 1</td>
<td style="text-align: left;">0_10004</td>
<td style="text-align: left;">MISS</td>
<td style="text-align: left;">L</td>
<td style="text-align: left;">ENNIS</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">1973-05-31</td>
<td style="text-align: left;">61052dbd3e94d0da0cefb0a0d2f230cf</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="secondary-identifiers" class="level3">
<h3 class="anchored" data-anchor-id="secondary-identifiers">Secondary identifiers</h3>
<p>Secondary identifiers are primarily variables not included within the id hash and/or ones that will not be used for blocking. These variables are also more likely to change over time and/or have higher levels of missingness. Common examples include <a href="R/create_history_variable.R">addresses</a> and <a href="R/create_history_variable.R">ZIP code</a>. Unlike the primary identifiers, these data are treated as list columns/sets/histories (e.g.&nbsp;does the address history for record A overlap with that of record B) and are kept at the source id level (at least in this document).</p>
<p>Note: The sample data used in this document only has one (or zero) addresses associated with each source id. However, the “history” approach to data transformation and analysis is used for demonstration purposes. The code (or at least the method) is scalable to longer histories and a one entry history is legitimate in any case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare the location histories</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    lh,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_location_history</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">input =</span> <span class="fu">c</span>(input_1, input_2),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># This changes based on data storage/format</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">output_file =</span> <span class="fu">file.path</span>(outdir, <span class="st">'lh.parquet'</span>),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">'source_system'</span>, <span class="st">'source_id'</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">X =</span> <span class="st">'X'</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y =</span> <span class="st">'Y'</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">'file'</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare ZIP code histories</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    zh,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_history_variable</span>(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">input =</span> <span class="fu">c</span>(input_1,input_2),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_file =</span> <span class="fu">file.path</span>(outdir, <span class="st">'zh.parquet'</span>),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">'source_system'</span>, <span class="st">'source_id'</span>),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="st">'zip_code'</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">clean_function =</span> clean_zip_code</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">'file'</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/2nd-vars.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="contextual-variables" class="level3">
<h3 class="anchored" data-anchor-id="contextual-variables">Contextual variables</h3>
<p>Frequency variables are useful to include within the modelling framework as they can adjust/downweight common names. For example, John Smith and John Smith likely is less informative than Unique Name and Unique Name because John Smith is more common. Using the <a href="R/create_frequency_table.R"><code>create_frequency_table</code></a> function, any variable can be the source of a frequency variable. For a given input value (e.g.&nbsp;John), the resulting relative frequency value computed and then scaled between 0 and 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create frequency tables</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    freqs,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_frequency_table</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">tables =</span> <span class="fu">list</span>(data),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">'first_name_noblank'</span>, <span class="st">'last_name_noblank'</span>, <span class="st">'dob_clean'</span>),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">output_folder =</span> outdir</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">format =</span> <span class="st">'file'</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/context-variables.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="other-data-cleaning-ideas" class="level3">
<h3 class="anchored" data-anchor-id="other-data-cleaning-ideas">Other data cleaning ideas</h3>
<ol type="1">
<li>In real data, there are common “junk” names – e.g.&nbsp;John Doe. These should be removed</li>
</ol>
</section>
</section>
<section id="training-data" class="level2">
<h2 class="anchored" data-anchor-id="training-data">Training data</h2>
<section id="creating-new-training-data" class="level3">
<h3 class="anchored" data-anchor-id="creating-new-training-data">Creating (new) training data</h3>
<p>Unlike probabilistic methods (e.g.&nbsp;splink), machine learning methods require training data to operate. When beginning a new project, a few options are available:</p>
<ol type="1">
<li>Borrow from a previously fit ML model</li>
<li>Borrow from a probabilistic model</li>
<li>Use some deterministic rules</li>
<li>Randomly sampled pairs, if you are mad</li>
</ol>
</section>
<section id="prepping-training-data-for-this-workflow" class="level3">
<h3 class="anchored" data-anchor-id="prepping-training-data-for-this-workflow">Prepping training data for this workflow</h3>
<p>The <code>pairs</code> dataset within <code>hyrule</code> is at the source id rather than the hash level. This next target/block of code converts from source id to hash id. Generally, this step will not be required as the training data will be natively at the hash level. Additionally, most users will have their training pairs stored in a database and/or as a set of loadable files (e.g.&nbsp;csv) that can be read in with <code>tarchetypes::tar_files_input</code>.</p>
<p>Minimally, labeled pairs (e.g.&nbsp;training data) should be stored in the following format:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">id1</th>
<th style="text-align: right;">id2</th>
<th style="text-align: right;">pair</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code>id1</code>, <code>id2</code>, and <code>pair</code> are all required columns. <code>pair</code> must be a numeric column with the values of 0 (no-match), 1 (match), or -1 (unknown). Additional columns can be added to the dataset, but they will be unused by the current implementation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: This step is mostly just so the example(s) can run</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(train_input,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">convert_sid_to_hid</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">pairs =</span> hyrule<span class="sc">::</span>train, </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>               arrow<span class="sc">::</span><span class="fu">read_parquet</span>(data),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">output_file =</span> <span class="fu">file.path</span>(outdir, <span class="st">'training.parquet'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>               ), <span class="at">format =</span> <span class="st">'file'</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># usually something like the following is better</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#tarchetypes::tar_files_input(train_input,'FILEPATHS to training data goes here'))</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/prep-traindat.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="specifying-a-formula" class="level3">
<h3 class="anchored" data-anchor-id="specifying-a-formula">Specifying a formula</h3>
<p>Like most modelling/regression/machine learning exercises, a formula must be specified. Something like <code>pair ~ varA + varB + varC</code> where <code>pair</code> refers to the column in the training data indicating whether two records are a match and <code>varA</code>, <code>varB</code>, and <code>varC</code> are variables that are likely predictive of the match-iness between two records. For this exercise, the following variables are of interest (and will be computed – see below):</p>
<ol type="1">
<li><code>dob_year_exact</code>: exact match of year of birth</li>
<li><code>dob_mdham</code>: hamming distance between month and day of birth</li>
<li><code>gender_agree</code>: gender explicitly matches</li>
<li><code>first_name_jw</code>: jaro-winkler distance of first names</li>
<li><code>last_name_jw</code>: jaro-winkler distance of last names</li>
<li><code>name_swap_jw</code>: jaro-winkler distance of names with first and last swapped</li>
<li><code>complete_name_dl</code>: daimaru-levenstein distance between the full names. Full name is either first + last or first + middle + last. The minimum distance of the two versions is used.</li>
<li><code>middle_initial_agree</code>: Explicit match of middle initial</li>
<li><code>last_in_last</code>: where either records’ whole last name is contained in the other one</li>
<li><code>first_name_freq</code>: Scaled frequency tabulation of first names</li>
<li><code>last_name_freq</code>: Scaled frequency tabulation of last names</li>
<li><code>zip_overlap</code>: Binary flag indicating zip code histories ever overlapped (not accounting for time)</li>
<li><code>exact_location</code>: binary flag indicating address histories overlap within 3 meters (location only – not spatio-temporal).</li>
</ol>
<div class="cell" data-tar_globals="true">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> pair <span class="sc">~</span> dob_year_exact <span class="sc">+</span> dob_mdham <span class="sc">+</span> gender_agree <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  first_name_jw <span class="sc">+</span> last_name_jw <span class="sc">+</span> name_swap_jw <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  complete_name_dl <span class="sc">+</span> middle_initial_agree <span class="sc">+</span> last_in_last <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  first_name_freq <span class="sc">+</span> last_name_freq <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  zip_overlap <span class="sc">+</span> exact_location</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/globals/formula.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-the-variables" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-variables">Creating the variables</h3>
<p>To create the variables specified by the formula, this workflow uses a function called <a href="R/make_model_frame.R"><code>make_model_frame</code></a>. <code>make_model_frame</code> takes a number of inputs (datasets, the training pairs, frequency tables, etc.) and computes the required columns from the data. The actual computation is handled in a temporary DuckDB database so that expressive (and relatively portable) sql can be used. DuckDB is also quite clever when working with parquet files and optimizing queries.</p>
</section>
<section id="compile-training-data" class="level3">
<h3 class="anchored" data-anchor-id="compile-training-data">Compile training data</h3>
<section id="load-and-prepare-training-data" class="level4">
<h4 class="anchored" data-anchor-id="load-and-prepare-training-data">Load and prepare training data</h4>
<p>At this stage, the <code>train_input</code> step is a basic data.frame (technically a file path to a data.frame) with three columns: <code>id1</code>, <code>id2</code>, and <code>pair</code>. As described above, the first two columns specify pairs of records while the <code>pair</code> column is a binary flag indicating whether the two (hash) ids are a match (1) or not (0). To be usable for model fitting, the training pairs must be screened for duplicates, contradictions (e.g.&nbsp;the first wave of training data says A !=B while the second set says A = B) must be reconciled, and the ids must be checked for validity (e.g.&nbsp;the input data might have changed the hash for a particular row so that a given pair in the training data doesn’t have a counterpart in the main data).</p>
</section>
<section id="computing-prediction-variables" class="level4">
<h4 class="anchored" data-anchor-id="computing-prediction-variables">Computing prediction variables</h4>
<p>Once the training pairs are prepared, the predictor variables must be created. In this workflow, the <code>make_model_frame</code> function is used to do this (usually nested within another function). This function takes in a few parquet file paths (and/or table specified by <code>DBI::Id()</code>) and generates a sql query that when executed in the the correct environment will return a data frame containing pair level variables.</p>
<p>For preparing the training data, <a href="R/compile_training_data.R"><code>compile_training_data</code></a> loads and standardizes labeled pairs, uses <code>make_model_frame</code> (with the previously created targets as inputs) to go from labeled pairs to “training data.” Before saving the results, some sanity checks are performed to ensure that too many of the labeled pairs get dropped due to missing data or some other set of data gremlins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    train_test_data, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">compile_training_data</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">input =</span> train_input,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">output_file =</span> <span class="fu">file.path</span>(outdir, <span class="st">'train_and_test.parquet'</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> f,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> data,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">loc_history =</span> lh,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">zip_history =</span> zh,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">freq_tab_first_name =</span> freqs[<span class="dv">1</span>],</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">freq_tab_last_name =</span> freqs[<span class="dv">2</span>],</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">freq_tab_dob =</span> freqs[<span class="dv">3</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/training-data.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="testtrain-split" class="level3">
<h3 class="anchored" data-anchor-id="testtrain-split">Test/train split</h3>
<p>The labeled data is split into two chunks datasets “train” and “test.” The training dataset will inform the models that will be fit on the later sections while the “test” dataset is held out and will be used to generate out of sample fit metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    training_hash,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    rlang<span class="sc">::</span><span class="fu">hash</span>(arrow<span class="sc">::</span><span class="fu">read_parquet</span>(train_test_data))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(test_train_split, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">split_tt</span>(<span class="at">hash =</span> training_hash, </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">training_data =</span> train_test_data, </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fraction =</span> .<span class="dv">15</span>, </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">train_of =</span> <span class="fu">file.path</span>(outdir, <span class="st">'train.parquet'</span>), </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">test_of =</span> <span class="fu">file.path</span>(outdir, <span class="st">'test.parquet'</span>))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>             , <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/split-test-train.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-specification" class="level2">
<h2 class="anchored" data-anchor-id="model-specification">Model specification</h2>
<p>The linkage model consists of three parts:</p>
<ol type="1">
<li>A lasso logistic regression that quickly screens out “obvious” matches and non-matches</li>
<li>A diverse series of models that are fit via cross-validation.</li>
<li>An ensemble model fit on the cross-validated results of the models generated in step 2 that makes the final match score.</li>
</ol>
<p>Step 1 is used for computation efficiency as logistic regressions produce match scores quickly and are good enough to produce ballpark estimates. Together, steps 2 and 3 are a “stacking” ensemble model approach where a diverse set of models are combined together to produce results that are better than a single model.</p>
<section id="screening-model" class="level3">
<h3 class="anchored" data-anchor-id="screening-model">Screening model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(screener, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command =</span> <span class="fu">fit_screening_model</span>(test_train_split[<span class="dv">2</span>], bounds, f))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/screener.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="submodels" class="level3">
<h3 class="anchored" data-anchor-id="submodels">Submodels</h3>
<p>For an effective ensemble, a variety of model families are employed. This example uses tuned versions of support vector machines, random forests, and xgboost gradient boosted machines.</p>
<div class="cell" data-tar_globals="true">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>svm <span class="ot">=</span> parsnip<span class="sc">::</span><span class="fu">svm_linear</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">'classification'</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">engine =</span> <span class="st">'kernlab'</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost =</span> <span class="fu">tune</span>())</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">=</span> parsnip<span class="sc">::</span><span class="fu">rand_forest</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">'classification'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>())</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>xg <span class="ot">=</span> parsnip<span class="sc">::</span><span class="fu">set_engine</span>(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  parsnip<span class="sc">::</span><span class="fu">boost_tree</span>(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">'classification'</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">tune</span>(), </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fu">tune</span>()),</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'xgboost'</span>, </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> <span class="st">'binary:logistic'</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>s_params <span class="ot">=</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>NAME, <span class="sc">~</span>MODEL,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'svm'</span>, <span class="fu">quote</span>(svm)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">'rf'</span>, <span class="fu">quote</span>(rf)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>                           ,<span class="st">'xg'</span>, <span class="fu">quote</span>(xg)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>s_params<span class="sc">$</span>TUNER <span class="ot">=</span> <span class="st">'bayes'</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>s_params<span class="sc">$</span>nm <span class="ot">=</span> s_params<span class="sc">$</span>NAME</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/globals/submodel_specs.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The stacking framework requires the submodels/child models to be fit with cross-validation (as a check against over-fitting). As such, the training dataset is subdivided into 5 approximately equal sized chunks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(tfolds, <span class="at">command =</span> <span class="fu">make_folds</span>(test_train_split[<span class="dv">2</span>], screener))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/submod-folds.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The models are tuned via <a href="https://tune.tidymodels.org/reference/tune_bayes.html">bayesian hyperparameter tuning</a> and the best performing models are considered for inclusion in the ensemble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>submods <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  tarchetypes<span class="sc">::</span><span class="fu">tar_map</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> s_params,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names =</span> <span class="st">'nm'</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tar_target</span>(submod,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>               <span class="fu">fit_submodel</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">train =</span> test_train_split[<span class="dv">2</span>],</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">screener =</span> screener,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">folds =</span> tfolds,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m =</span> MODEL,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">theform =</span> f,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">apply_screen =</span> apply_screen</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/submod-fit.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="stacked-ensemble-model" class="level3">
<h3 class="anchored" data-anchor-id="stacked-ensemble-model">Stacked ensemble model</h3>
<p>The submodels are ensembled together via a lasso regression. The output model object is also saved.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>tarchetypes<span class="sc">::</span><span class="fu">tar_combine</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    submods,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">command =</span> <span class="fu">create_stacked_model</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!!</span>.x,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">mnames =</span> s_params<span class="sc">$</span>nm,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">screener =</span> screener,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">bounds =</span> bounds</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(model_path,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(model, <span class="fu">file.path</span>(outdir, <span class="st">'model.rds'</span>))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.path</span>(outdir, <span class="st">'model.rds'</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/z-ensemble.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="blocking" class="level2">
<h2 class="anchored" data-anchor-id="blocking">Blocking</h2>
<p>Blocking creates the list of pairs to evaluate for match scores. In this implementation, a series of sql statements are evaluated and the pairs that fit one or more of those conditions are cached for evaluation via the linkage model.</p>
<section id="specifying-blocking-rules-with-sql" class="level3">
<h3 class="anchored" data-anchor-id="specifying-blocking-rules-with-sql">Specifying blocking rules with SQL</h3>
<p>Blocking rules are specified as DuckDB friendly SQL statements and refer to a <code>l</code> and a <code>r</code> dataset. In this implementation, both <code>l</code> and <code>r</code> are the <code>data</code> target. The <code>splink</code> package<a href="https://moj-analytical-services.github.io/splink/demos/tutorials/03_Blocking.html">has a great write up on good blocking rules</a> and the approach used in this example is heavily influenced by the splink package.</p>
<p>Three rules are instantiated below:</p>
<ol type="1">
<li>Exact match on last name</li>
<li>Exact match on DOB</li>
<li>Fuzzy match on first name and exact match on year</li>
</ol>
<p>For further evaluation, a pair of records must meet at least one of the conditions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>blocking_rules <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'l.last_name_noblank = r.last_name_noblank'</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'l.dob_clean = r.dob_clean'</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"jaro_winkler_similarity(l.first_name_noblank, r.first_name_noblank) &gt;.7</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">   and datepart('year', l.dob_clean) = datepart('year', r.dob_clean)"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  tarchetypes<span class="sc">::</span><span class="fu">tar_group_by</span>(qgrid, </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">command =</span> <span class="fu">make_block_rules</span>(<span class="at">rules =</span> blocking_rules),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>                            qid)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/block-1.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="computing-and-compiling-pairs-for-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="computing-and-compiling-pairs-for-evaluation">Computing and compiling pairs for evaluation</h3>
<p>Once the blocking rules have been properly formatted and prepared, they are then computed. The <code>deduplicate</code> argument in the <a href="R/blocking.R"><code>make_block</code></a> function (<code>blocks</code> target) governs whether records from the same source system are “allowed” to be included in the final set of blocked pairs. Records from the same source system with the same source id are automatically excluded from final list of evaluation pairs as they will be added as fixed links by a later step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(blocks, <span class="fu">make_block</span>(<span class="at">q =</span> qgrid, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> data, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">id_col =</span> <span class="st">'clean_hash'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">deduplicate =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">output_folder =</span> outdir),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">map</span>(qgrid),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">format =</span> <span class="st">'file'</span>),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(bids, <span class="fu">compile_blocks</span>(<span class="at">blocks =</span> blocks, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">output_folder =</span> outdir, </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                                <span class="at">chk_size =</span> <span class="dv">10000</span>), <span class="at">format =</span> <span class="st">'file'</span>),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(bid_files, bids)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/block-2.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At the end of the blocking process, the <code>bid_files</code> target links to a series of data.frames (saved as parquet files) that consist of the pairs that be assessed for match probability.</p>
</section>
</section>
<section id="predicting-match-scores" class="level2">
<h2 class="anchored" data-anchor-id="predicting-match-scores">Predicting match scores</h2>
<section id="using-the-ensemble" class="level3">
<h3 class="anchored" data-anchor-id="using-the-ensemble">Using the ensemble</h3>
<p>For all blocked pairs, a match score is generated and those where the match probability is &gt;.05 are saved. As described above, pairs are first evaluated by the lasso screening models and those that are within the range specified by <code>bounds</code> (default: [.01 - .99]) are further evaluated by the overall ensemble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(preds,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">predict_links</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">pairs =</span> bid_files,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">model =</span> model_path,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">output_folder =</span> outdir,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> data,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">loc_history =</span> lh,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">zip_history =</span> zh,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">freq_tab_first_name =</span> freqs[<span class="dv">1</span>],</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">freq_tab_last_name =</span> freqs[<span class="dv">2</span>],</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">freq_tab_dob =</span> freqs[<span class="dv">3</span>]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">pattern =</span> <span class="fu">map</span>(bid_files), </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">iteration =</span> <span class="st">'list'</span>, </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/z-predictions.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fixed-links" class="level3">
<h3 class="anchored" data-anchor-id="fixed-links">Fixed links</h3>
<p>Depending on the linkage problem, there may be certain pairs of records that must be considered matches, regardless of the match score. In this example, records with the same source system and source id, but different hash ids are automatically considered matches (they are ignored during the blocking step, but added here). The <a href="R/fixed_links.R">fixed_links</a> function adds those records to the results set as exact matches (i.e.&nbsp;match score of 1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(fixed, </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">fixed_links</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> data,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">model_path =</span> model_path,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">fixed_vars =</span> <span class="fu">c</span>(<span class="st">'source_system'</span>, <span class="st">'source_id'</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">id_col =</span> <span class="st">'clean_hash'</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">output_file =</span> <span class="fu">file.path</span>(outdir, <span class="st">'fixed_links.parquet'</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>             ), <span class="at">format =</span> <span class="st">'file'</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/fixed-links.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluation-and-cutoffs" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-and-cutoffs">Evaluation and cutoffs</h2>
<p>The ensemble produces match scores on a scale of 0 to 1. However, whether or not two records are a “match” is a binary value and therefore the scores must be discretized. To find a good cutoff point, 3 rounds of 5-fold cross validation are used. For each fold, the entire ensemble is refit via <a href="R/cv_refit.R"><code>cv_refit</code></a>(although the hyperparameters are inherited from the main model) on 4/5ths of the training data, and the cutoff that optimizes accuracy is computed.</p>
<div class="cell" data-tar_globals="true">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>cutoff_df <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">iter =</span> <span class="dv">1</span><span class="sc">:</span>i, <span class="at">name =</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>i))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/globals/a-cutoffs.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cv_cutoffs <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  tarchetypes<span class="sc">::</span><span class="fu">tar_map</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> cutoff_df,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names =</span> <span class="st">'name'</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tar_target</span>(cv_co,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">cv_refit</span>(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">train =</span> test_train_split[<span class="dv">2</span>],</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">model_path =</span> model_path,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">apply_screen =</span> apply_screen,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">iteration =</span> iter,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nfolds =</span> <span class="dv">5</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">lasso =</span> T </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                 ))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/b-cutoffs.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="identifying-the-cutpoint-and-oos-statistics" class="level3">
<h3 class="anchored" data-anchor-id="identifying-the-cutpoint-and-oos-statistics">Identifying the cutpoint and OOS statistics</h3>
<p>The final cutoff point is averaged over each iteration of the cross validation process (the <code>cv_co</code> set of products) via the <a href="R/identify_cutoff.R"><code>identify_cutoff</code></a> function. This function also computes the full out of sample (OOS) results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>tarchetypes<span class="sc">::</span><span class="fu">tar_combine</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    cutme,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    cv_cutoffs,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">command =</span> <span class="fu">identify_cutoff</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!!</span>.x,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">test =</span> test_train_split[<span class="dv">1</span>],</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">mods =</span> model_path</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(cutme_path,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(cutme, <span class="fu">file.path</span>(outdir, <span class="st">'cutme.rds'</span>))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.path</span>(outdir, <span class="st">'cutme.rds'</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/z-cutoffs.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="from-11-links-to-networks" class="level2">
<h2 class="anchored" data-anchor-id="from-11-links-to-networks">From 1:1 links to networks</h2>
<p>Once a set of links at the hash id level have been identified, they must be aggregated to the level of interest – in this case, source id. This is done by organizing all the individual 1:1 links together into a series of networks and aggregating those networks by source id. The <a href="R/compile_links.R"><code>compile_links</code></a> function does this two step aggregation process and computes some metrics at each scale (e.g.&nbsp;the hash id level and then the source id level).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(components, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">compile_links</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>             preds,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>             fixed,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> data, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">id_col =</span> <span class="st">'clean_hash'</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">cutpoint =</span> cutme<span class="sc">$</span>cutpoint,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">output_folder =</span> outdir</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>           ), <span class="at">format =</span> <span class="st">'file'</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Establish _targets.R and _targets_r/targets/compile-components.R.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="applying-constraints" class="level3">
<h3 class="anchored" data-anchor-id="applying-constraints">Applying constraints</h3>
<p>While this example does not have any network based constraints, certain uses cases may require the implementation of deterministic rules. For example, when linking death records to other types of administrative information, users may want to enforce a rule that only one death record may within a network/cluster of linkages (otherwise, it would imply the “person” represented by the collection of records died twice). The implementation of those sorts of rules is probably best done as part of the <code>complile_links</code> function (or as a new subsequent step).</p>
</section>
<section id="identity-table" class="level3">
<h3 class="anchored" data-anchor-id="identity-table">Identity Table</h3>
<p>The first part of results stored in <code>components</code> target is a file path to a parquet file containing the final results: a data frame that crosswalks between <code>clean_hash</code>, <code>source_id</code> &amp; <code>source_system</code>, and <code>final_comp_id</code>. This latter variable is final entity identity. All source ids with the same <code>final_comp_id</code> can be considered as representing the same “person” (or equivalent).</p>
<p>As currently implemented, the <code>final_comp_id</code>s are not persistent between model versions.</p>
</section>
</section>
<section id="did-it-work" class="level2">
<h2 class="anchored" data-anchor-id="did-it-work">Did it work?</h2>
<section id="assessing-the-evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="assessing-the-evaluation-metrics">Assessing the evaluation metrics</h3>
</section>
<section id="manual-evaluation-heuristics" class="level3">
<h3 class="anchored" data-anchor-id="manual-evaluation-heuristics">Manual evaluation heuristics</h3>
<section id="large-low-density-clusters" class="level4">
<h4 class="anchored" data-anchor-id="large-low-density-clusters">Large low density clusters</h4>
</section>
<section id="twins" class="level4">
<h4 class="anchored" data-anchor-id="twins">Twins</h4>
</section>
<section id="multiple-people-within-a-source-id" class="level4">
<h4 class="anchored" data-anchor-id="multiple-people-within-a-source-id">Multiple people within a source id</h4>
</section>
</section>
</section>
</section>
<section id="odds-and-ends" class="level1">
<h1>Odds and ends</h1>
<section id="porting-an-old-model-into-new-data" class="level2">
<h2 class="anchored" data-anchor-id="porting-an-old-model-into-new-data">Porting an old model into new data</h2>
</section>
<section id="iterative-development-principles" class="level2">
<h2 class="anchored" data-anchor-id="iterative-development-principles">Iterative development principles</h2>
</section>
<section id="opportunities-for-future-improvement" class="level2">
<h2 class="anchored" data-anchor-id="opportunities-for-future-improvement">Opportunities for future improvement</h2>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>